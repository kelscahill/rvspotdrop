"use strict";var WPFormsGeolocationAlgoliaPlacesAPI=window.WPFormsGeolocationAlgoliaPlacesAPI||function(o,t){var a,n=[],l={},s={init:function(){"loading"===o.readyState?o.addEventListener("DOMContentLoaded",s.ready):s.ready()},ready:function(){s.getFields(),n.length&&(s.initGeocoder(),n.forEach(function(e){s.initMap(e),s.initAutocomplete(e)}),s.detectGeolocation())},showDebugMessage:function(e){t.location.hash&&"#wpformsdebug"===t.location.hash&&console.log(e)},closest:function(e,t){for(var a=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;e&&!a.call(e,t);)e=e.parentElement;return e},getFields:function(){Array.prototype.slice.call(o.querySelectorAll('.wpforms-form .wpforms-field input[type="text"][data-autocomplete="1"]')).forEach(function(e){var t=s.closest(e,".wpforms-field"),a=e.hasAttribute("data-display-map")?t.querySelector(".wpforms-geolocation-map"):null,o=t.classList[1]?t.classList[1].replace("wpforms-field-",""):"text",i={};"address"===o&&(i={city:t.querySelector(".wpforms-field-address-city"),suburb:t.querySelector(".wpforms-field-address-state"),postcode:t.querySelector(".wpforms-field-address-postal"),countryCode:t.querySelector(".wpforms-field-address-country")}),n.push({searchField:e,mapField:a,type:o,additionalFields:i})})},initMap:function(t){var e,a;t.mapField&&(e=wpforms_geolocation_settings.default_location,a=wpforms_geolocation_settings.zoom,t.map=L.map(t.mapField,{zoom:a,center:e}),a=new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:5,maxZoom:18}),t.map.addLayer(a),s.updateMap(t,e),t.mapField.parentElement.classList.contains("wpforms-conditional-field")&&new MutationObserver(function(e){e.forEach(function(e){t.map.invalidateSize()})}).observe(t.mapField.parentElement,{attributes:!0,attributeFilter:["style"]}))},initGeocoder:function(){a=algoliasearch.initPlaces(wpforms_geolocation_settings.app_id,wpforms_geolocation_settings.api_key)},markerDragend:function(e){var t=s.findFieldPlaceByMarker(this);t&&s.detectByCoordinates(t,{lat:e.latLng.lat(),lng:e.latLng.lng()})},detectByCoordinates:function(t,e){t.autocomplete&&a.reverse({aroundLatLng:e.lat+","+e.lng,hitsPerPage:1}).then(function(e){e.hits&&e.hits[0]&&s.updateFields(t,e.hits[0])})},updateMap:function(e,t){e.map&&(e.marker&&e.map.removeLayer(e.marker),e.marker=L.marker(t,{opacity:1,draggable:!0}),e.marker.addTo(e.map),e.map.setView(t),e.marker.on("moveend",s.markerChanged))},markerChanged:function(){var e=s.findFieldPlaceByMap(this._map);s.updateMap(e,this._latlng),s.detectByCoordinates(e,this._latlng)},findFieldPlaceByMap:function(t){var a=null;return n.forEach(function(e){e.map===t&&(a=e)}),a},findFieldPlaceByAutocomplete:function(t){var a=null;return n.forEach(function(e){e.autocomplete===t&&(a=e)}),a},findFieldPlaceByCountryCode:function(t){var a=null;return n.forEach(function(e){e.additionalFields&&e.additionalFields.countryCode&&e.additionalFields.countryCode===t&&(a=e)}),a},findFieldPlaceByState:function(t){var a=null;return n.forEach(function(e){e.additionalFields&&e.additionalFields.suburb&&e.additionalFields.suburb===t&&(a=e)}),a},initAutocomplete:function(e){var t={appId:wpforms_geolocation_settings.app_id,apiKey:wpforms_geolocation_settings.api_key,container:e.searchField},a={language:wpforms_geolocation_settings.language,type:"address",style:!1};"address"===e.type?s.initAutocompleteAddressField(e,t,a):s.initAutocompleteTextField(e,t,a)},initAutocompleteTextField:function(t,e,a){var o=t.searchField.parentNode;Array.prototype.slice.call(t.searchField.classList).forEach(function(e){-1!==e.indexOf("wpforms-field-")&&(t.searchField.classList.remove(e),o.classList.add(e))}),o.classList.add("wpforms-field-row"),t.mapField&&(t.mapField.classList.remove("wpforms-field-small"),t.mapField.classList.remove("wpforms-field-medium"),t.mapField.classList.remove("wpforms-field-large")),t.autocomplete=places(e).configure(a),s.bindTextFieldEvents(t)},bindTextFieldEvents:function(e){e.autocomplete.on("change",s.updateFieldPlace).on("clear",s.clearButtonCallback),e.searchField.addEventListener("focusin",s.addActiveClass),e.searchField.addEventListener("focusout",s.removeActiveClass)},addActiveClass:function(){this.parentElement.classList.add("algolia-places-active")},removeActiveClass:function(){this.parentElement.classList.remove("algolia-places-active")},clearButtonCallback:function(){var e=s.findFieldPlaceByAutocomplete(this);e&&s.triggerEvent(e.searchField,"change")},initAutocompleteAddressField:function(e,t,a){t.templates={value:function(e){return e.name}},e.additionalFields.countryCode||(a.countries=["us"]),e.autocomplete=places(t).configure(a),-1!==navigator.userAgent.indexOf("Chrome")&&e.searchField.setAttribute("autocomplete","chrome-off"),s.bindAddressFieldEvents(e)},bindAddressFieldEvents:function(e){if(e.additionalFields.countryCode&&e.additionalFields.countryCode.addEventListener("change",s.updateCountry),!e.additionalFields.countryCode&&e.additionalFields.suburb){const i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){var e,t,a,o=JSON.parse(i.responseText);for(e in o)Object.prototype.hasOwnProperty.call(o,e)&&(a=(t=o[e]).name,delete t.name,l[a]=t,l[a].code=e)}},i.open("GET",wpforms_geolocation_settings.states),i.send(),e.additionalFields.suburb.addEventListener("change",s.updateArea)}e.autocomplete.on("change",s.updateFieldPlace).on("clear",s.clearButtonCallback),e.searchField.addEventListener("focusin",s.addActiveClass),e.searchField.addEventListener("focusout",s.removeActiveClass)},updateFieldPlace:function(e){var t;e.suggestion&&e.suggestion.hit&&e.suggestion.latlng&&((t=s.findFieldPlaceByAutocomplete(this))&&(s.updateFields(t,e.suggestion.hit),s.updateMap(t,e.suggestion.latlng)))},updateFields:function(e,t){"text"===e.type?s.updateTextField(e,t):"address"===e.type&&s.updateAddressField(e,t),s.triggerEvent(e.searchField,"change"),s.showDebugMessage("Fields was updated"),s.showDebugMessage(e),s.showDebugMessage(t)},updateTextField:function(e,t){var a=[];["locale_names","city","administrative","country"].forEach(function(e){t[e]&&a.push(s.getTranslatedPlaceField(e,t))}),a.filter(function(e){return e.toString().trim()}),e.autocomplete.setVal(a.join(", "))},triggerEvent:function(e,t){var a=o.createEvent("HTMLEvents");a.initEvent(t,!0,!0),e.dispatchEvent(a)},getTranslatedPlaceField:function(e,t){return t[e]?"string"==typeof t[e]?t[e]:t[e].default?t[e][wpforms_geolocation_settings.language]||t[e].default:t[e][0]||"":""},updateAddressField:function(t,a){["city","postcode"].forEach(function(e){a[e]&&t.additionalFields[e]&&(t.additionalFields[e].value=s.getTranslatedPlaceField(e,a))}),s.updateAddressFieldState(t.additionalFields.suburb,a),a.country_code&&t.additionalFields.countryCode&&(t.additionalFields.countryCode.value=a.country_code.toString().toUpperCase()),a.locale_names&&a.locale_names.default&&t.autocomplete.setVal(s.getTranslatedPlaceField("locale_names",a))},updateAddressFieldState:function(e,t){var a;t.administrative&&(a=s.getTranslatedPlaceField("administrative",t)),!a&&t.suburb&&(a=s.getTranslatedPlaceField("suburb",t)),a&&"select"===e.tagName.toLowerCase()&&(a=s.getStateCodyByName(a)),e.value=a},getStateCodyByName:function(e){return l[e]&&Object.prototype.hasOwnProperty.call(l[e],"code")?l[e].code:""},updateCountry:function(){var e=s.findFieldPlaceByCountryCode(this),t=this.value.toString().toLocaleLowerCase();e&&e.autocomplete&&(e.autocomplete.configure({countries:[t],language:wpforms_geolocation_settings.language,type:"address"}),s.showDebugMessage("Autocomplete field restrict to country: "+t))},updateArea:function(){var e=s.findFieldPlaceByState(this),t=this.value.toString().toUpperCase();e&&e.autocomplete&&l[t]&&(e.autocomplete.configure({countries:["us"],language:wpforms_geolocation_settings.language,type:"address",aroundLatLng:Object.values(l[t]).join()}),s.showDebugMessage("Autocomplete field restrict to state: "+t))},detectGeolocation:function(){var t;wpforms_geolocation_settings.current_location&&navigator.geolocation&&n&&(t={},navigator.geolocation.getCurrentPosition(function(e){t={lat:e.coords.latitude.toFixed(6),lng:e.coords.longitude.toFixed(6)},n.forEach(function(e){s.updateMap(e,t),s.detectByCoordinates(e,t)})}))}};return s}(document,window);WPFormsGeolocationAlgoliaPlacesAPI.init();